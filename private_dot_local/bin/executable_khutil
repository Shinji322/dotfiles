#!/bin/bash
depends=('fzf', 'khinsider', 'sed')
MUSIC_DIR="$HOME/mus/game"
tty -s && menu='fzf --multi' || menu='rofi -dmenu'


die() {
  for msg in $@; do
    echo "\033[0;31m$msg\033[0m"
  done
  exit 1
}

selgame() {
  if [ "$(tty -s)" ]; then
    read -r -a game -p 'Game name: '
  else
    game="$($menu -p 'Game name')"
  fi
}

main() {
  game="$1"
  [ -z "$game" ] && selgame
  [ -z "$game" ] && exit 1
  choice="$(khinsider -s "$game" | sed -r 's/(^[a-z0-9-]+).*/\1/;/^[^a-z0-9]/d;/^$/d' | $menu)"
  [ -z "$choice" ] && exit 1
  [ ! -d "$MUSIC_DIR" ] && mkdir -pv "$MUSIC_DIR"
  # i hate cding in scripts
  cd "$MUSIC_DIR"
  notify-send "Downloading $game!"
  khinsider "$choice" -f "flac,mp3" &
}

main $@
